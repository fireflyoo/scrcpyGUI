<html>
<head>
    <HTA:APPLICATION SCROLL="yes" SYSMENU="no" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv=content-type content='charset=utf-8' />
    <meta http-equiv=msthemecompatible content=yes />
    <title>HTA Buttons</title>
    <script language="JScript">
    window.resizeTo(450,620);

    function exec(command){
        var shell = new ActiveXObject("WScript.Shell"),
        exec = shell.Exec(command);
        return { Out: exec.StdOut.ReadAll(),
		         Err: exec.StdErr.ReadAll(),
				 ExitCode: exec.ExitCode
				 }
    }
	function run(command){
        var shell = new ActiveXObject("WScript.Shell")
        return shell.Run("cmd /c "+command+" 2> err.log > out.log",0,false);
        
    }
	function getOptions() {
		var result=[];
		for(var i=0;i<options.length;i++){
			if(options[i].checked)
				result.push(options[i].value)
		} 
		return " "+result.join(" ")
	}
	function showTips(result,device){
		out.innerText=result.Out
		err.innerText=result.Err
		if(result.ExitCode==0 && result.Out.slice(0,4)!="fail"){
			_exitCode.style.color="green"
			_exitCode.innerText="Success"
			run('scrcpy -s '+device+getOptions())}
		else {
			_exitCode.style.color="red"
			_exitCode.innerText="Failed"
		}
	}
	function wireless() {
		var result=exec('adb connect ' + IP.value)
		showTips(result,IP.value)
		refreshDevicesList()
		}
	function wifiPair() {
		var result=exec('adb pair '+IP.value)
		showTips(result,IP.value)
	}

	function refreshDevicesList() {
		var lines=exec("adb devices").Out.split("\r\n")
		var ls_devices=lines.slice(1,-2).map(function (line){
			return line.split(/\s/)
		}
		)
		devices.options.length=0;
		ls_devices.forEach(function(fields){
			var newOption=new Option(fields[0]+"\t"+fields[1],fields[0])
			if(fields[1]!="device")
				newOption.style.color="red"
			devices.add(newOption)
		})
		if(devices.options.length!=0)devices.options[0].selected = true
	}
	function fromUsbToWifi() {
		var result=exec('adb -d tcpip 5555')
		out.innerText=result.Out
		err.innerText=result.Err
		if(result.ExitCode==0){
			_exitCode.innerText="Success"
			run('scrcpy -d --tcpip '+getOptions())
		} else {
			_exitCode.innerText="Failed"
		}
	}

	window.onload = function () {
		refreshDevicesList();
		refresh.onclick=refreshDevicesList

		open_err.onclick=function(){
			var shell = new ActiveXObject("WScript.Shell"),
			exitCode = shell.Run("notepad err.log",1,false);
			return exitCode
		}
		close_window.onclick=function () {
			window.close();
		}
		usb2wifi.onclick=fromUsbToWifi;
		del.onclick=function() {
			var result=exec('adb disconnect '+devices.value)
			refreshDevicesList()
			out.innerText=result.Out
			err.innerText=result.Err
		}
		otg.onclick=function() {
			var exitCode=run('scrcpy -s'+devices.value+' --otg')
			if(exitCode!=0)err.innerText="Fail"
		}
		launch.onclick=function() {
			var result=exec('adb connect '+devices.value)
			showTips(result,devices.value)
		}
		pair_start.onclick=wifiPair
		start.onclick=wireless;
	}
    </script>
    <style>
        *{color:gray}
		#err{color:red}
		body{background-color:black}
		h2{font-size:20px}
		select{width:250px}
        button{background-color:black; border-color:white}
    </style>
</head>
<body>
    <h2>Scrcpy</h2>   
    <hr>
    <button id="usb2wifi">一键无线</button>
	<button id="open_err">错误日志</button>
    <button id="close_window">close</button>
    <hr>
	<br>
	<h3>Connect from IP or Pair from Wifi</h3>
    <input type="text" id="IP"  placeholder="IP:Port [PairCode]">
    <button id="start">Start</button>
	<button id="pair_start">Pair</button><lable id="_exitCode"></lable><br>
	<h3>Connect from Device</h3>
	<select id="devices" size=5 ><select><br>
	<button id="launch">Launch</button>
	<button id="refresh">Refresh</button>
	<button id="del">Delete</button>
	<button id="otg" title="Only work with USB-Connected">OTG</button>
	<fieldset>
    <legend>配置</legend>
    <input type="checkbox" name="options" value="--turn-screen-off" checked><lable>自动息屏</lable>
    <input type="checkbox" name="options" value="--stay-awake" checked><lable title="只在USB有线下有效">保持唤醒</lable>
	<input type="checkbox" name="options" value="--power-off-on-close" checked><lable title="">关后息屏</lable>
    <input type="checkbox" name="options" value="--always-on-top" checked><lable title="--always-on-top">窗口置顶</lable>
	<br>
	<input type="checkbox" name="options" value="--window-borderless"><lable title="--window-borderless">无边框窗</lable>
	<input type="checkbox" name="options" value="--disable-screensaver" checked><lable title="--disable-screensaver">禁止屏保</lable>
	<input type="checkbox" name="options" value="--no-audio"><lable title="--no-audio">禁投音频</lable>
    <input type="checkbox" name="options" value="--no-control"><lable title="--no-control">禁止操控</lable>
    </fieldset>
    <pre id="out"></pre>
	<pre id="err"></pre>
</body>
</html>
